import os
import sys
import time

from ppadb.client import Client as AdbClient
from prompt_toolkit import prompt as input
import subprocess as sub
# integrated = True
#!#!#!
# This uses pure
# a device that's plugged in via usb
#
# REQUIRED OPTIONS
#!#!#!

installation = f'{os.getenv("HOME")}/.SuperSploit'
# Default is "127.0.0.1" and 5037
client = AdbClient(host="127.0.0.1", port=5037)
devices = client.devices()
serials = []

class RemoteConnect:
    def ip(self):
        ipp = []
        for device in devices:
            try:
                devicesInfo = str(device.shell('ip addr | grep "wlan0"')).split('\n')
                ipp.append(str(devicesInfo[1].split(' ')[5].split("/")[0]))
            except Exception:
                ipp.append(str(device.get_serial_no()))
                pass
        return ipp

    # Connect to discovered device
    @classmethod
    def adb_connect(cls, device):
        ipp = cls().ip()
        if len(ipp) < 1:
            print("no connected devices")
            return
        for x in ipp:
            print(f"{ipp.index(x)}: {x}")
        inn = input(f"please pick a device: ")
        sub.run(['adb', "-s", f"{devices[int(inn)].get_serial_no()}", 'tcpip', '5555'])
        time.sleep(2)
        print("\033[H\033[J")
        sub.run([f'adb', 'connect', f'{ipp[int(inn)]}:5555'])

def shell(device) -> str:
    print(device)
    data = input("enter shell command: ")
    print(device.shell(data))
    return True

def install(device):
    """iterate through the .data/.apps folder, then display apps use index of app to install
    via device.install(app_path) call from ppadb"""
    apps = os.listdir(f"{installation}.data/.app")
    for x in apps:
        print(f"{apps.index(x)}: {x}")
    try:
        index = input("Enter the index of the app to install")
        device.install(f"{installation}/.data/.app/{apps[int(index)]}")
        return
    except ValueError:
        print("Please enter the index of the app")
        return

def Help(args):
    print("\033[H\033[J")
    print("""[Help For ADB Interface]
-------------------------------------------------------------------
    connect: Create a remote connection to device from usb
    shell: Runs a shell command
    install: starts the installer""")


def code():
    if len(devices) < 1:
        return "No devices connected"
    for x in devices:
        serials.append(x.get_serial_no())
        print(f"{devices.index(x)}: {x.get_serial_no()}")
    try:
        de = devices[int(input("Enter the index of the device: "))]
        print(f"Using device {de.get_serial_no()}")
        functs = [shell, Help, install, RemoteConnect.adb_connect]
        inputs = ["shell", "help", "install", "connect"]
        while True:
            try:
                data = input("[adb_interface]: ")
                for x in inputs:
                    if data in x:
                        functs[inputs.index(x)](de)
                        continue
            except KeyboardInterrupt:
                sys.exit()
    except:
        print("Error Please enter the index of the device to use")
        return False


print(code())

