# integrated = True
#!#!#!
# This uses adb to create a remote connection to
# a trusted device that's plugged in via usb
# not a exploit this requires
#
# REQUIRED OPTIONS
# L_HOST: Local host default 12.0.0.1
# L_PORT: local port default 5037
#!#!#!
import subprocess as sub
import time
from ppadb.client import Client as AdbClient

installation = f'{os.getenv("HOME")}/.SuperSploit'

with open(f"{installation}/.data/data.json", 'r') as file:
    di = json.load(file)
    file.close()

client = AdbClient(host=di["L_HOST"], port=["L_PORT"])
devices = client.devices()

# Get device ip address by running ifconfig wlan0 via a adb test
def ip():
    ipp = []
    for device in devices:
        try:
            devicesInfo = str(device.shell('ip addr | grep "wlan0"')).split('\n')
            ipp.append(str(devicesInfo[1].split(' ')[5].split("/")[0]))
        except Exception:
            ipp.append(str(device.get_serial_no()))
            pass
    return ipp


# Connect to discovered device
def adb_connect():
    ipp = ip()
    if len(ipp) < 1:
        print("no connected devices")
        return
    for x in ipp:
        print(f"{ipp.index(x)}: {x}")
    inn = input(f"please pick a device: ")
    sub.run(['adb', "-s", f"{devices[int(inn)].get_serial_no()}", 'tcpip', '5555'])
    time.sleep(2)
    print("\033[H\033[J")
    sub.run([f'adb', 'connect', f'{ipp[int(inn)]}:5555'])


adb_connect()
