import subprocess as sub
import time

from ppadb.client import Client as AdbClient
import ppadb


# integrated = True
#!#!#!
# This uses adb to create a remote connection to
# a device that's plugged in via usb
#
# REQUIRED OPTIONS
#!#!#!

# Default is "127.0.0.1" and 5037
client = AdbClient(host="127.0.0.1", port=5037)
devices = client.devices()

# Get device ip address by running ifconfig wlan0 via a adb test
def ip():
    ipp = []
    for device in devices:
        try:
            devicesInfo = str(device.shell('ip addr | grep "wlan0"')).split('\n')
            ipp.append(str(devicesInfo[1].split(' ')[5].split("/")[0]))
        except Exception:
            ipp.append(str(device.get_serial_no()))
            pass
    return ipp


# Connect to discovered device
def adb_connect():
    ipp = ip()
    if len(ipp) < 1:
        print("no connected devices")
        return
    for x in ipp:
        print(f"{ipp.index(x)}: {x}")
    inn = input(f"please pick a device: ")
    sub.run(['adb', "-s", f"{devices[int(inn)].get_serial_no()}", 'tcpip', '5555'])
    time.sleep(2)
    print("\033[H\033[J")
    sub.run([f'adb', 'connect', f'{ipp[int(inn)]}:5555'])


adb_connect()
